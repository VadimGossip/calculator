## Распределенный вычислитель арифметических выражений
### [Ссылка на telegram автора](https://t.me/iyozy)

## Описание
Комплекс сервисов илюстрирующих распределенную модель вычислений и основным паттерны, которые могут быть использованы
для ее реализации.

## В основе лежат следующиет требования
Пользователь хочет считать арифметические выражения.
Он вводит строку 2 + 2 * 2 и хочет получить в ответ 6. Но наши операции сложения и умножения (также деления и вычитания) выполняются "очень-очень" долго.
Поэтому вариант, при котором пользователь делает http-запрос и получает в качетсве ответа результат, невозможна.
Более того: вычисление каждой такой операции в нашей "альтернативной реальности" занимает "гигантские" вычислительные мощности.
Соответственно, каждое действие мы должны уметь выполнять отдельно и масштабировать эту систему можем добавлением вычислительных мощностей в нашу систему в виде новых "машин".
Поэтому пользователь, присылая выражение, получает в ответ идентификатор выражения и может с какой-то периодичностью уточнять у сервера "не посчиталость ли выражение"?
Если выражение наконец будет вычислено - то он получит результат. Помните, что некоторые части арфиметического выражения можно вычислять параллельно.

## Разворачивание
Для запуска требуется выполнить сначала команду
```
docker compose up -d
```
Потом создать структуру таблиц с помощью скрипта миграции
Потребуется инструмент migrate [source](https://github.com/golang-migrate/migrate)
```
migrate -path ./schema -database "postgres://postgres:postgres@localhost:5432/calculator_db?sslmode=disable" up
```
Для удаления таблицу
```
migrate -path ./schema -database "postgres://postgres:postgres@localhost:5432/calculator_db?sslmode=disable" down
```

## Особенности реализации
В docker compose описано создание системы из 5 контейнеров. 
1) calculator-api. http сервер, принимает запросы от клиента с заданиями и от агентов вычислителей с посчитанными заданиями и heartbeat
2) message-broker. Брокер сообщений RabbitMQ, используется для передачи сообщений агентам-вычислителям.
3) calculator_db. База данных на Postgres. В нее вносится информация о посчитанных выражениях, подвыражениях, которые находятся в процессе рассчета,
пользовательские настройки длительностей операций и региструются heartbeat агентов вычислителей.
4) calculator-agentN. Агент вычислитель, достает подвыражение из очереди и передает рабочему внутри сервиса на вычисление, количество одновременно допустимых
рабочих регулируется переменной среды. В данном примере поднимаются 2 агента.

## Использование
Сервис api принимает следующие запросы.
1) Запрос на постановку выражения на вычисление.
```
curl --location --request POST 'http://localhost:8080/expression' --header 'Content-Type: application/json' --data '{
    "expression": "1/1/2.2/3.3"
}'
```
Допустимы выражения, хотя бы с одним знаком операции, не более 50 символов в длину(регулируется параметром в конфиге), состоящие из
чисел(целые и с плавающей точкой) и знаков операций `+-/*`. Скобки, двойные знаки операций(-*, +-, -+ и так далее) недопустимы, планирую добавить позднее.
2) Запрос на отображение всех выражений
```
curl --location --request GET 'http://localhost:8080/expression'
```
Выражения могут быть в процессе расчета, рассчитаны с ошибкой(деление на 0), расчитаны без ошибки.
3) Запрос на добавление замедления для той или иной математической операции. Так как мы имитируем нагрузку на вычислителях. Каждую из четырех допустимых
математических операций можно замедлить. Замедление передается в ms. Допустимы значения от 0 до 65535
Если длительность уже зарегистрированна, ее значение будет перезаписано на новое переданное в запросе. По умолчанию замедление 0.
```
curl --location --request POST 'http://localhost:8080/duration' --header 'Content-Type: application/json' --data '{
    "+":5000,
    "-":5000,
    "*":1000,
    "/":10000
}'
```
4) Запрос на возвращение всех Агентов. Возращает список зарегистрированных агентов-вычислителей, с их именем, датой создания и heartbeat.
```

```

## Переменные окружения